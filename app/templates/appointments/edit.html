{% extends "base.html" %}

{% block title %}Edit Appointment - Clinic Management{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header Section -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{{ url_for('appointments.list') }}">Appointments</a></li>
                    <li class="breadcrumb-item"><a href="{{ url_for('appointments.detail', id=1) }}">Appointment #APT001</a></li>
                    <li class="breadcrumb-item active">Edit</li>
                </ol>
            </nav>
            <h2><i class="fas fa-edit"></i> Edit Appointment</h2>
            <p class="text-muted">Modify appointment details and settings</p>
        </div>
        <div>
            <a href="{{ url_for('appointments.detail', id=1) }}" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left"></i> Back to Details
            </a>
        </div>
    </div>

    <form id="editAppointmentForm">
        <div class="row">
            <!-- Left Column - Main Details -->
            <div class="col-lg-8">
                <!-- Basic Information -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-info-circle"></i> Basic Information</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <label class="form-label">Appointment ID</label>
                                <input type="text" class="form-control" value="#APT001" readonly>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Status *</label>
                                <select class="form-select" name="status" required>
                                    <option value="pending">Pending</option>
                                    <option value="confirmed" selected>Confirmed</option>
                                    <option value="completed">Completed</option>
                                    <option value="cancelled">Cancelled</option>
                                    <option value="no_show">No Show</option>
                                </select>
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-md-6">
                                <label class="form-label">Priority *</label>
                                <select class="form-select" name="priority" required>
                                    <option value="low">Low</option>
                                    <option value="normal" selected>Normal</option>
                                    <option value="high">High</option>
                                    <option value="urgent">Urgent</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Service Type *</label>
                                <select class="form-select" name="service_type" required>
                                    <option value="consultation" selected>General Consultation</option>
                                    <option value="checkup">Health Checkup</option>
                                    <option value="vaccination">Vaccination</option>
                                    <option value="dental">Dental Care</option>
                                    <option value="pediatric">Pediatric Care</option>
                                    <option value="cardiology">Cardiology</option>
                                    <option value="lab">Laboratory Tests</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Patient Selection -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-user"></i> Patient Information</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-8">
                                <label class="form-label">Patient *</label>
                                <div class="input-group">
                                    <input type="text" class="form-control" id="patientSearch" 
                                           placeholder="Search patient by name, ID, or phone..." 
                                           value="John Doe (PAT001)" readonly>
                                    <button class="btn btn-outline-secondary" type="button" onclick="selectPatient()">
                                        <i class="fas fa-search"></i> Change Patient
                                    </button>
                                </div>
                                <input type="hidden" name="patient_id" value="1">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Patient Type</label>
                                <select class="form-select" name="patient_type">
                                    <option value="existing" selected>Existing Patient</option>
                                    <option value="new">New Patient</option>
                                    <option value="follow_up">Follow-up</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- Patient Quick Info -->
                        <div class="mt-3 p-3 bg-light rounded">
                            <div class="row">
                                <div class="col-md-3">
                                    <img src="https://via.placeholder.com/80" class="rounded-circle" alt="Patient">
                                </div>
                                <div class="col-md-9">
                                    <h6>John Doe</h6>
                                    <p class="mb-1"><strong>Age:</strong> 35 years | <strong>Gender:</strong> Male</p>
                                    <p class="mb-1"><strong>Phone:</strong> +1 234 567 8901</p>
                                    <p class="mb-0"><strong>Last Visit:</strong> Dec 15, 2024</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Doctor and Schedule -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-user-md"></i> Doctor & Schedule</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <label class="form-label">Doctor *</label>
                                <select class="form-select" name="doctor_id" required onchange="updateDoctorInfo()">
                                    <option value="">Select Doctor</option>
                                    <option value="1" selected>Dr. John Smith - General Medicine</option>
                                    <option value="2">Dr. Sarah Johnson - Pediatrics</option>
                                    <option value="3">Dr. Michael Brown - Cardiology</option>
                                    <option value="4">Dr. Emily Davis - Dermatology</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Duration</label>
                                <select class="form-select" name="duration">
                                    <option value="15">15 minutes</option>
                                    <option value="30" selected>30 minutes</option>
                                    <option value="45">45 minutes</option>
                                    <option value="60">1 hour</option>
                                    <option value="90">1.5 hours</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="row mt-3">
                            <div class="col-md-4">
                                <label class="form-label">Appointment Date *</label>
                                <input type="date" class="form-control" name="appointment_date" 
                                       value="2024-12-28" required onchange="updateAvailableSlots()">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Appointment Time *</label>
                                <input type="time" class="form-control" name="appointment_time" 
                                       value="10:30" required>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Room/Location</label>
                                <select class="form-select" name="room">
                                    <option value="">Auto-assign</option>
                                    <option value="101" selected>Room 101</option>
                                    <option value="102">Room 102</option>
                                    <option value="103">Room 103</option>
                                    <option value="201">Room 201</option>
                                </select>
                            </div>
                        </div>

                        <!-- Doctor Availability Info -->
                        <div class="mt-3 p-3 bg-info bg-opacity-10 rounded">
                            <h6 class="text-info"><i class="fas fa-info-circle"></i> Doctor Availability</h6>
                            <div class="row">
                                <div class="col-md-6">
                                    <p class="mb-1"><strong>Available Slots:</strong></p>
                                    <div class="d-flex flex-wrap gap-1">
                                        <span class="badge bg-success">10:00 AM</span>
                                        <span class="badge bg-primary">10:30 AM</span>
                                        <span class="badge bg-success">11:00 AM</span>
                                        <span class="badge bg-success">2:00 PM</span>
                                        <span class="badge bg-success">3:30 PM</span>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <p class="mb-1"><strong>Next Available:</strong> Dec 29, 2024 at 9:00 AM</p>
                                    <p class="mb-0"><strong>Booked Today:</strong> 6 appointments</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Appointment Details -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-clipboard-list"></i> Appointment Details</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-12">
                                <label class="form-label">Reason for Visit *</label>
                                <textarea class="form-control" name="reason" rows="3" required 
                                    placeholder="Describe the reason for this appointment...">Patient complaining of persistent headaches for the past week. Headaches are more severe in the morning and accompanied by mild nausea.</textarea>
                            </div>
                        </div>
                        
                        <div class="row mt-3">
                            <div class="col-md-6">
                                <label class="form-label">Symptoms</label>
                                <textarea class="form-control" name="symptoms" rows="3" 
                                    placeholder="List current symptoms...">Headaches (7 days)
Morning nausea
Mild dizziness
Fatigue</textarea>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Additional Notes</label>
                                <textarea class="form-control" name="notes" rows="3" 
                                    placeholder="Any additional information...">Patient has been taking over-the-counter pain medication with minimal relief. No recent changes in medication or lifestyle.</textarea>
                            </div>
                        </div>

                        <div class="row mt-3">
                            <div class="col-md-6">
                                <label class="form-label">Preparation Instructions</label>
                                <textarea class="form-control" name="instructions" rows="2" 
                                    placeholder="Pre-appointment instructions for patient..."></textarea>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Special Requirements</label>
                                <textarea class="form-control" name="requirements" rows="2" 
                                    placeholder="Wheelchair access, interpreter, etc..."></textarea>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Column - Additional Settings -->
            <div class="col-lg-4">
                <!-- Billing Information -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-dollar-sign"></i> Billing Information</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">Consultation Fee</label>
                            <div class="input-group">
                                <span class="input-group-text">$</span>
                                <input type="number" class="form-control" name="fee" value="50.00" step="0.01">
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Payment Status</label>
                            <select class="form-select" name="payment_status">
                                <option value="pending" selected>Pending</option>
                                <option value="paid">Paid</option>
                                <option value="partial">Partial</option>
                                <option value="cancelled">Cancelled</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Insurance</label>
                            <select class="form-select" name="insurance">
                                <option value="">No Insurance</option>
                                <option value="blue_cross" selected>Blue Cross Blue Shield</option>
                                <option value="aetna">Aetna</option>
                                <option value="cigna">Cigna</option>
                                <option value="medicare">Medicare</option>
                            </select>
                        </div>

                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="insurance_verified" id="insuranceVerified">
                            <label class="form-check-label" for="insuranceVerified">
                                Insurance verified
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Notifications -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-bell"></i> Notifications</h5>
                    </div>
                    <div class="card-body">
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" name="email_reminder" id="emailReminder" checked>
                            <label class="form-check-label" for="emailReminder">
                                Email reminder (24 hours before)
                            </label>
                        </div>
                        
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" name="sms_reminder" id="smsReminder" checked>
                            <label class="form-check-label" for="smsReminder">
                                SMS reminder (2 hours before)
                            </label>
                        </div>
                        
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" name="call_reminder" id="callReminder">
                            <label class="form-check-label" for="callReminder">
                                Phone call reminder
                            </label>
                        </div>

                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="confirmation_required" id="confirmationRequired" checked>
                            <label class="form-check-label" for="confirmationRequired">
                                Require patient confirmation
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Follow-up -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-redo"></i> Follow-up</h5>
                    </div>
                    <div class="card-body">
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" name="schedule_followup" id="scheduleFollowup">
                            <label class="form-check-label" for="scheduleFollowup">
                                Schedule follow-up appointment
                            </label>
                        </div>

                        <div id="followupDetails" style="display: none;">
                            <div class="mb-3">
                                <label class="form-label">Follow-up in</label>
                                <select class="form-select" name="followup_period">
                                    <option value="1_week">1 week</option>
                                    <option value="2_weeks">2 weeks</option>
                                    <option value="1_month" selected>1 month</option>
                                    <option value="3_months">3 months</option>
                                    <option value="6_months">6 months</option>
                                </select>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Follow-up Type</label>
                                <select class="form-select" name="followup_type">
                                    <option value="in_person">In-person</option>
                                    <option value="phone">Phone call</option>
                                    <option value="video">Video call</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="card">
                    <div class="card-body">
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save"></i> Update Appointment
                            </button>
                            
                            <button type="button" class="btn btn-success" onclick="saveAndConfirm()">
                                <i class="fas fa-check"></i> Save & Confirm
                            </button>
                            
                            <div class="btn-group">
                                <button type="button" class="btn btn-outline-secondary" onclick="saveAsDraft()">
                                    <i class="fas fa-draft2digital"></i> Save as Draft
                                </button>
                                <button type="button" class="btn btn-outline-info" onclick="previewAppointment()">
                                    <i class="fas fa-eye"></i> Preview
                                </button>
                            </div>
                            
                            <hr>
                            
                            <a href="{{ url_for('appointments.detail', id=1) }}" class="btn btn-outline-secondary">
                                <i class="fas fa-times"></i> Cancel Changes
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

<!-- Patient Selection Modal -->
<div class="modal fade" id="patientSelectionModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Select Patient</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <input type="text" class="form-control" placeholder="Search patients..." id="modalPatientSearch">
                </div>
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Patient</th>
                                <th>ID</th>
                                <th>Phone</th>
                                <th>Last Visit</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <img src="https://via.placeholder.com/32" class="rounded-circle me-2">
                                        <div>
                                            <div class="fw-bold">John Doe</div>
                                            <small class="text-muted">35 years, Male</small>
                                        </div>
                                    </div>
                                </td>
                                <td>PAT001</td>
                                <td>+1 234 567 8901</td>
                                <td>Dec 15, 2024</td>
                                <td>
                                    <button class="btn btn-sm btn-primary" onclick="selectPatientFromModal('1', 'John Doe (PAT001)')">
                                        Select
                                    </button>
                                </td>
                            </tr>
                            <!-- More patient rows... -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Edit appointment JavaScript
document.addEventListener('DOMContentLoaded', function() {
    // Form submission
    document.getElementById('editAppointmentForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        if (validateForm()) {
            const formData = new FormData(this);
            console.log('Updating appointment...');
            
            // Show success message
            showAlert('Appointment updated successfully!', 'success');
            
            // Redirect after short delay
            setTimeout(() => {
                window.location.href = '/appointments/detail/1';
            }, 1500);
        }
    });

    // Follow-up checkbox toggle
    document.getElementById('scheduleFollowup').addEventListener('change', function() {
        const followupDetails = document.getElementById('followupDetails');
        followupDetails.style.display = this.checked ? 'block' : 'none';
    });

    // Patient search in modal
    document.getElementById('modalPatientSearch').addEventListener('input', function() {
        // Implement patient search logic
        console.log('Searching patients:', this.value);
    });
});

function updateDoctorInfo() {
    // Update doctor availability and information
    console.log('Updating doctor info...');
}

function updateAvailableSlots() {
    // Update available time slots based on date and doctor
    console.log('Updating available slots...');
}

function selectPatient() {
    const modal = new bootstrap.Modal(document.getElementById('patientSelectionModal'));
    modal.show();
}

function selectPatientFromModal(patientId, patientName) {
    document.getElementById('patientSearch').value = patientName;
    document.querySelector('input[name="patient_id"]').value = patientId;
    bootstrap.Modal.getInstance(document.getElementById('patientSelectionModal')).hide();
}

function saveAndConfirm() {
    // Set status to confirmed and save
    document.querySelector('select[name="status"]').value = 'confirmed';
    document.getElementById('editAppointmentForm').dispatchEvent(new Event('submit'));
}

function saveAsDraft() {
    // Save as draft without validation
    console.log('Saving as draft...');
    showAlert('Appointment saved as draft!', 'info');
}

function previewAppointment() {
    // Show appointment preview
    console.log('Showing preview...');
}

function validateForm() {
    // Form validation logic
    const requiredFields = document.querySelectorAll('[required]');
    let isValid = true;
    
    requiredFields.forEach(field => {
        if (!field.value.trim()) {
            field.classList.add('is-invalid');
            isValid = false;
        } else {
            field.classList.remove('is-invalid');
        }
    });
    
    if (!isValid) {
        showAlert('Please fill in all required fields.', 'error');
    }
    
    return isValid;
}

function showAlert(message, type = 'info') {
    const alertClass = type === 'success' ? 'alert-success' : 
                      type === 'error' ? 'alert-danger' : 
                      type === 'warning' ? 'alert-warning' : 'alert-info';
    
    const alertHtml = `
        <div class="alert ${alertClass} alert-dismissible fade show" role="alert">
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;
    
    // Insert alert at the top of the form
    const form = document.getElementById('editAppointmentForm');
    form.insertAdjacentHTML('afterbegin', alertHtml);
    
    // Auto-dismiss after 5 seconds
    setTimeout(() => {
        const alert = form.querySelector('.alert');
        if (alert) {
            const bsAlert = new bootstrap.Alert(alert);
            bsAlert.close();
        }
    }, 5000);
}
</script>

<style>
.is-invalid {
    border-color: #dc3545;
}

.badge {
    cursor: pointer;
}

.badge:hover {
    opacity: 0.8;
}

.bg-opacity-10 {
    --bs-bg-opacity: 0.1;
}

.card-header h5 {
    color: #495057;
}

.form-label {
    font-weight: 600;
    color: #495057;
}

.text-info {
    color: #0dcaf0 !important;
}
</style>
{% endblock %}
