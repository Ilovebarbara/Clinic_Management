{% extends "base.html" %}

{% block title %}Book Appointment - HealthCare Clinic{% endblock %}

{% block extra_css %}
<style>
    .booking-container {
        max-width: 1000px;
        margin: 0 auto;
    }
    .step-indicator {
        display: flex;
        justify-content: center;
        margin-bottom: 2rem;
    }
    .step {
        display: flex;
        align-items: center;
        margin: 0 1rem;
    }
    .step-number {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: #dee2e6;
        color: #6c757d;
        display: flex;
        align-items: center;
        justify-content-center;
        font-weight: bold;
        margin-right: 0.5rem;
    }
    .step.active .step-number {
        background: #007bff;
        color: white;
    }
    .step.completed .step-number {
        background: #28a745;
        color: white;
    }
    .booking-card {
        border: none;
        border-radius: 15px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        margin-bottom: 2rem;
    }
    .calendar-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 5px;
        margin-bottom: 1rem;
    }
    .calendar-day {
        aspect-ratio: 1;
        border: 1px solid #dee2e6;
        border-radius: 5px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    .calendar-day:hover {
        background: #e3f2fd;
    }
    .calendar-day.selected {
        background: #007bff;
        color: white;
        border-color: #007bff;
    }
    .calendar-day.disabled {
        background: #f8f9fa;
        color: #6c757d;
        cursor: not-allowed;
    }
    .calendar-day.unavailable {
        background: #ffebee;
        color: #d32f2f;
        cursor: not-allowed;
    }
    .time-slots {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        gap: 10px;
        margin-bottom: 1rem;
    }
    .time-slot {
        padding: 0.75rem;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    .time-slot:hover {
        background: #e3f2fd;
        border-color: #007bff;
    }
    .time-slot.selected {
        background: #007bff;
        color: white;
        border-color: #007bff;
    }
    .time-slot.unavailable {
        background: #f8f9fa;
        color: #6c757d;
        cursor: not-allowed;
    }
    .doctor-card {
        border: 1px solid #dee2e6;
        border-radius: 10px;
        padding: 1rem;
        margin-bottom: 1rem;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    .doctor-card:hover {
        border-color: #007bff;
        box-shadow: 0 2px 8px rgba(0,123,255,0.2);
    }
    .doctor-card.selected {
        border-color: #007bff;
        background: #f8f9fa;
    }
    .service-option {
        border: 1px solid #dee2e6;
        border-radius: 10px;
        padding: 1.5rem;
        margin-bottom: 1rem;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    .service-option:hover {
        border-color: #007bff;
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(0,123,255,0.2);
    }
    .service-option.selected {
        border-color: #007bff;
        background: #f8f9fa;
    }
    .booking-summary {
        background: #f8f9fa;
        border-radius: 10px;
        padding: 1.5rem;
        position: sticky;
        top: 20px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container booking-container">
    <!-- Page Header -->
    <div class="text-center mb-4">
        <h2><i class="fas fa-calendar-plus"></i> Book an Appointment</h2>
        <p class="text-muted">Schedule your visit with our healthcare professionals</p>
    </div>

    <!-- Step Indicator -->
    <div class="step-indicator">
        <div class="step active" id="step1">
            <div class="step-number">1</div>
            <span>Service</span>
        </div>
        <div class="step" id="step2">
            <div class="step-number">2</div>
            <span>Doctor</span>
        </div>
        <div class="step" id="step3">
            <div class="step-number">3</div>
            <span>Date & Time</span>
        </div>
        <div class="step" id="step4">
            <div class="step-number">4</div>
            <span>Details</span>
        </div>
        <div class="step" id="step5">
            <div class="step-number">5</div>
            <span>Confirm</span>
        </div>
    </div>

    <div class="row">
        <!-- Main Booking Form -->
        <div class="col-lg-8">
            <form id="bookingForm">
                <!-- Step 1: Service Selection -->
                <div class="booking-card card" id="serviceStep">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-stethoscope"></i> Select Service</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <div class="service-option" onclick="selectService('general', 'General Medicine', 30, 100)">
                                    <div class="d-flex align-items-center">
                                        <i class="fas fa-stethoscope fa-3x text-primary me-3"></i>
                                        <div>
                                            <h5 class="mb-1">General Medicine</h5>
                                            <p class="mb-1">Comprehensive medical care and consultation</p>
                                            <small class="text-muted">Duration: 30 minutes | Fee: $100</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <div class="service-option" onclick="selectService('dental', 'Dental Care', 45, 150)">
                                    <div class="d-flex align-items-center">
                                        <i class="fas fa-tooth fa-3x text-primary me-3"></i>
                                        <div>
                                            <h5 class="mb-1">Dental Care</h5>
                                            <p class="mb-1">Dental examination and treatment</p>
                                            <small class="text-muted">Duration: 45 minutes | Fee: $150</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <div class="service-option" onclick="selectService('pediatric', 'Pediatric Care', 30, 120)">
                                    <div class="d-flex align-items-center">
                                        <i class="fas fa-baby fa-3x text-primary me-3"></i>
                                        <div>
                                            <h5 class="mb-1">Pediatric Care</h5>
                                            <p class="mb-1">Specialized care for children</p>
                                            <small class="text-muted">Duration: 30 minutes | Fee: $120</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <div class="service-option" onclick="selectService('specialist', 'Specialist Consultation', 60, 200)">
                                    <div class="d-flex align-items-center">
                                        <i class="fas fa-user-md fa-3x text-primary me-3"></i>
                                        <div>
                                            <h5 class="mb-1">Specialist Consultation</h5>
                                            <p class="mb-1">Specialized medical consultation</p>
                                            <small class="text-muted">Duration: 60 minutes | Fee: $200</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <div class="service-option" onclick="selectService('followup', 'Follow-up Visit', 20, 75)">
                                    <div class="d-flex align-items-center">
                                        <i class="fas fa-redo fa-3x text-primary me-3"></i>
                                        <div>
                                            <h5 class="mb-1">Follow-up Visit</h5>
                                            <p class="mb-1">Follow-up consultation</p>
                                            <small class="text-muted">Duration: 20 minutes | Fee: $75</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <div class="service-option" onclick="selectService('emergency', 'Emergency Consultation', 30, 250)">
                                    <div class="d-flex align-items-center">
                                        <i class="fas fa-ambulance fa-3x text-danger me-3"></i>
                                        <div>
                                            <h5 class="mb-1">Emergency Consultation</h5>
                                            <p class="mb-1">Urgent medical attention</p>
                                            <small class="text-muted">Duration: 30 minutes | Fee: $250</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Step 2: Doctor Selection -->
                <div class="booking-card card" id="doctorStep" style="display: none;">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-user-md"></i> Select Doctor</h5>
                    </div>
                    <div class="card-body">
                        <div id="doctorList">
                            <!-- Doctors will be loaded dynamically -->
                        </div>
                    </div>
                </div>

                <!-- Step 3: Date & Time Selection -->
                <div class="booking-card card" id="dateTimeStep" style="display: none;">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-calendar-alt"></i> Select Date & Time</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h6>Select Date</h6>
                                <div class="calendar-header d-flex justify-content-between align-items-center mb-3">
                                    <button type="button" class="btn btn-outline-secondary btn-sm" onclick="previousMonth()">
                                        <i class="fas fa-chevron-left"></i>
                                    </button>
                                    <h6 id="currentMonth" class="mb-0"></h6>
                                    <button type="button" class="btn btn-outline-secondary btn-sm" onclick="nextMonth()">
                                        <i class="fas fa-chevron-right"></i>
                                    </button>
                                </div>
                                <div class="calendar-weekdays">
                                    <div class="row text-center text-muted mb-2">
                                        <div class="col">Sun</div>
                                        <div class="col">Mon</div>
                                        <div class="col">Tue</div>
                                        <div class="col">Wed</div>
                                        <div class="col">Thu</div>
                                        <div class="col">Fri</div>
                                        <div class="col">Sat</div>
                                    </div>
                                </div>
                                <div class="calendar-grid" id="calendarGrid">
                                    <!-- Calendar days will be generated here -->
                                </div>
                            </div>
                            <div class="col-md-6">
                                <h6>Available Time Slots</h6>
                                <div id="timeSlots">
                                    <p class="text-muted">Please select a date first</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Step 4: Appointment Details -->
                <div class="booking-card card" id="detailsStep" style="display: none;">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-info-circle"></i> Appointment Details</h5>
                    </div>
                    <div class="card-body">
                        {% if not current_user.is_authenticated or current_user.role == 'staff' %}
                        <!-- Patient Selection for Staff or Guest -->
                        <div class="mb-3">
                            <label class="form-label">Patient *</label>
                            <select class="form-select" name="patient_id" required>
                                <option value="">Select Patient</option>
                                {% for patient in patients %}
                                <option value="{{ patient.id }}" {{ 'selected' if request.args.get('patient_id') == patient.id|string else '' }}>
                                    {{ patient.first_name }} {{ patient.last_name }} ({{ patient.patient_id or 'ID: Pending' }})
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        {% endif %}

                        <div class="mb-3">
                            <label class="form-label">Reason for Visit *</label>
                            <textarea class="form-control" name="reason" rows="3" required 
                                placeholder="Please describe the reason for your appointment..."></textarea>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Priority</label>
                                    <select class="form-select" name="priority">
                                        <option value="normal">Normal</option>
                                        <option value="high">High</option>
                                        <option value="urgent">Urgent</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Appointment Type</label>
                                    <select class="form-select" name="appointment_type">
                                        <option value="new_patient">New Patient</option>
                                        <option value="follow_up">Follow-up</option>
                                        <option value="consultation">Consultation</option>
                                        <option value="check_up">Check-up</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Additional Notes</label>
                            <textarea class="form-control" name="notes" rows="2" 
                                placeholder="Any additional information or special requests..."></textarea>
                        </div>

                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" name="send_confirmation" id="sendConfirmation" checked>
                            <label class="form-check-label" for="sendConfirmation">
                                Send appointment confirmation via email/SMS
                            </label>
                        </div>

                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="reminder" id="reminder" checked>
                            <label class="form-check-label" for="reminder">
                                Send appointment reminder 24 hours before
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Step 5: Confirmation -->
                <div class="booking-card card" id="confirmationStep" style="display: none;">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-check-circle"></i> Confirm Appointment</h5>
                    </div>
                    <div class="card-body">
                        <div id="appointmentSummary">
                            <!-- Summary will be populated here -->
                        </div>
                        
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i>
                            <strong>Please review your appointment details carefully.</strong>
                            You will receive a confirmation email once the appointment is booked.
                        </div>

                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="termsAccept" required>
                            <label class="form-check-label" for="termsAccept">
                                I agree to the <a href="#" data-bs-toggle="modal" data-bs-target="#termsModal">terms and conditions</a>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Navigation Buttons -->
                <div class="d-flex justify-content-between mt-4">
                    <button type="button" class="btn btn-outline-secondary" id="prevBtn" onclick="previousStep()" style="display: none;">
                        <i class="fas fa-arrow-left"></i> Previous
                    </button>
                    <div></div>
                    <button type="button" class="btn btn-primary" id="nextBtn" onclick="nextStep()">
                        Next <i class="fas fa-arrow-right"></i>
                    </button>
                    <button type="submit" class="btn btn-success" id="submitBtn" style="display: none;">
                        <i class="fas fa-check"></i> Book Appointment
                    </button>
                </div>
            </form>
        </div>

        <!-- Booking Summary Sidebar -->
        <div class="col-lg-4">
            <div class="booking-summary">
                <h5><i class="fas fa-calendar-check"></i> Booking Summary</h5>
                <hr>
                
                <div id="selectedService" style="display: none;">
                    <h6>Service</h6>
                    <p class="mb-1" id="serviceName"></p>
                    <small class="text-muted" id="serviceDetails"></small>
                    <hr>
                </div>

                <div id="selectedDoctor" style="display: none;">
                    <h6>Doctor</h6>
                    <p class="mb-1" id="doctorName"></p>
                    <small class="text-muted" id="doctorSpecialty"></small>
                    <hr>
                </div>

                <div id="selectedDateTime" style="display: none;">
                    <h6>Date & Time</h6>
                    <p class="mb-1" id="appointmentDate"></p>
                    <p class="mb-0" id="appointmentTime"></p>
                    <hr>
                </div>

                <div id="appointmentFee" style="display: none;">
                    <h6>Fee</h6>
                    <h4 class="text-primary" id="totalFee">$0</h4>
                </div>

                <!-- Quick Contact -->
                <div class="mt-4 pt-3 border-top">
                    <h6>Need Help?</h6>
                    <p class="mb-1"><i class="fas fa-phone"></i> (555) 123-4567</p>
                    <p class="mb-0"><i class="fas fa-envelope"></i> appointments@clinic.com</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Terms Modal -->
<div class="modal fade" id="termsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Terms and Conditions</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <h6>Appointment Booking Terms</h6>
                <ul>
                    <li>Please arrive 15 minutes before your scheduled appointment time</li>
                    <li>Cancellations must be made at least 24 hours in advance</li>
                    <li>A cancellation fee may apply for late cancellations</li>
                    <li>Please bring a valid ID and insurance card</li>
                    <li>Payment is due at the time of service</li>
                </ul>
                <h6>Privacy Policy</h6>
                <p>Your personal and medical information will be kept confidential and used only for providing healthcare services.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let currentStep = 1;
let selectedService = null;
let selectedDoctor = null;
let selectedDate = null;
let selectedTime = null;
let currentMonth = new Date();

document.addEventListener('DOMContentLoaded', function() {
    generateCalendar();
    
    // Handle form submission
    document.getElementById('bookingForm').addEventListener('submit', function(e) {
        e.preventDefault();
        bookAppointment();
    });
});

function selectService(serviceId, serviceName, duration, fee) {
    // Remove previous selections
    document.querySelectorAll('.service-option').forEach(option => {
        option.classList.remove('selected');
    });
    
    // Select current option
    event.currentTarget.classList.add('selected');
    
    selectedService = {
        id: serviceId,
        name: serviceName,
        duration: duration,
        fee: fee
    };
    
    updateSummary();
    enableNextButton();
}

function loadDoctors() {
    if (!selectedService) return;
    
    // Show loading
    document.getElementById('doctorList').innerHTML = '<div class="text-center"><i class="fas fa-spinner fa-spin"></i> Loading doctors...</div>';
    
    // Fetch doctors for the selected service
    fetch(`/appointments/api/doctors?service=${selectedService.id}`)
        .then(response => response.json())
        .then(data => {
            let doctorsHtml = '';
            
            if (data.doctors && data.doctors.length > 0) {
                data.doctors.forEach(doctor => {
                    doctorsHtml += `
                        <div class="doctor-card" onclick="selectDoctor('${doctor.id}', '${doctor.name}', '${doctor.specialty}', ${doctor.rating})">
                            <div class="row align-items-center">
                                <div class="col-md-2 text-center">
                                    ${doctor.photo ? 
                                        `<img src="${doctor.photo}" class="rounded-circle" width="60" height="60" alt="Dr. ${doctor.name}">` :
                                        `<div class="bg-primary text-white rounded-circle d-inline-flex align-items-center justify-content-center" style="width: 60px; height: 60px;">
                                            ${doctor.name.split(' ').map(n => n[0]).join('')}
                                        </div>`
                                    }
                                </div>
                                <div class="col-md-8">
                                    <h6 class="mb-1">Dr. ${doctor.name}</h6>
                                    <p class="mb-1">${doctor.specialty}</p>
                                    <div class="d-flex align-items-center">
                                        <div class="me-3">
                                            ${generateStars(doctor.rating)}
                                            <small class="text-muted">(${doctor.rating}/5)</small>
                                        </div>
                                        <small class="text-muted">${doctor.experience} years experience</small>
                                    </div>
                                </div>
                                <div class="col-md-2 text-end">
                                    <span class="badge bg-${doctor.available ? 'success' : 'warning'}">
                                        ${doctor.available ? 'Available' : 'Limited'}
                                    </span>
                                </div>
                            </div>
                        </div>
                    `;
                });
            } else {
                doctorsHtml = '<div class="text-center py-4"><i class="fas fa-user-md fa-3x text-muted mb-3"></i><h6 class="text-muted">No doctors available for this service</h6></div>';
            }
            
            document.getElementById('doctorList').innerHTML = doctorsHtml;
        })
        .catch(error => {
            console.error('Error loading doctors:', error);
            document.getElementById('doctorList').innerHTML = '<div class="alert alert-danger">Error loading doctors. Please try again.</div>';
        });
}

function selectDoctor(doctorId, doctorName, specialty, rating) {
    // Remove previous selections
    document.querySelectorAll('.doctor-card').forEach(card => {
        card.classList.remove('selected');
    });
    
    // Select current option
    event.currentTarget.classList.add('selected');
    
    selectedDoctor = {
        id: doctorId,
        name: doctorName,
        specialty: specialty,
        rating: rating
    };
    
    updateSummary();
    enableNextButton();
}

function generateCalendar() {
    const year = currentMonth.getFullYear();
    const month = currentMonth.getMonth();
    
    // Update month header
    document.getElementById('currentMonth').textContent = 
        currentMonth.toLocaleString('default', { month: 'long', year: 'numeric' });
    
    const firstDay = new Date(year, month, 1).getDay();
    const daysInMonth = new Date(year, month + 1, 0).getDate();
    const today = new Date();
    
    let calendarHtml = '';
    
    // Empty cells for days before the first day of the month
    for (let i = 0; i < firstDay; i++) {
        calendarHtml += '<div class="calendar-day disabled"></div>';
    }
    
    // Days of the month
    for (let day = 1; day <= daysInMonth; day++) {
        const date = new Date(year, month, day);
        const isPast = date < today.setHours(0, 0, 0, 0);
        const isWeekend = date.getDay() === 0 || date.getDay() === 6;
        
        let dayClass = 'calendar-day';
        if (isPast) {
            dayClass += ' disabled';
        } else if (isWeekend) {
            dayClass += ' unavailable';
        }
        
        calendarHtml += `<div class="${dayClass}" onclick="selectDate('${year}-${(month + 1).toString().padStart(2, '0')}-${day.toString().padStart(2, '0')}')">${day}</div>`;
    }
    
    document.getElementById('calendarGrid').innerHTML = calendarHtml;
}

function selectDate(dateStr) {
    if (event.currentTarget.classList.contains('disabled') || 
        event.currentTarget.classList.contains('unavailable')) {
        return;
    }
    
    // Remove previous selection
    document.querySelectorAll('.calendar-day').forEach(day => {
        day.classList.remove('selected');
    });
    
    // Select current date
    event.currentTarget.classList.add('selected');
    selectedDate = dateStr;
    
    // Load available time slots
    loadTimeSlots(dateStr);
    updateSummary();
}

function loadTimeSlots(date) {
    if (!selectedDoctor) return;
    
    document.getElementById('timeSlots').innerHTML = '<div class="text-center"><i class="fas fa-spinner fa-spin"></i> Loading time slots...</div>';
    
    fetch(`/appointments/api/timeslots?doctor=${selectedDoctor.id}&date=${date}`)
        .then(response => response.json())
        .then(data => {
            let slotsHtml = '';
            
            if (data.slots && data.slots.length > 0) {
                data.slots.forEach(slot => {
                    slotsHtml += `
                        <div class="time-slot ${slot.available ? '' : 'unavailable'}" 
                             onclick="selectTime('${slot.time}', ${slot.available})">
                            ${slot.time}
                            ${slot.available ? '' : '<br><small>Booked</small>'}
                        </div>
                    `;
                });
            } else {
                slotsHtml = '<div class="text-center py-4"><i class="fas fa-clock fa-3x text-muted mb-3"></i><h6 class="text-muted">No time slots available</h6></div>';
            }
            
            document.getElementById('timeSlots').innerHTML = slotsHtml;
        })
        .catch(error => {
            console.error('Error loading time slots:', error);
            document.getElementById('timeSlots').innerHTML = '<div class="alert alert-danger">Error loading time slots. Please try again.</div>';
        });
}

function selectTime(time, available) {
    if (!available) return;
    
    // Remove previous selection
    document.querySelectorAll('.time-slot').forEach(slot => {
        slot.classList.remove('selected');
    });
    
    // Select current time
    event.currentTarget.classList.add('selected');
    selectedTime = time;
    
    updateSummary();
    enableNextButton();
}

function previousMonth() {
    currentMonth.setMonth(currentMonth.getMonth() - 1);
    generateCalendar();
}

function nextMonth() {
    currentMonth.setMonth(currentMonth.getMonth() + 1);
    generateCalendar();
}

function nextStep() {
    if (currentStep === 1 && !selectedService) {
        alert('Please select a service');
        return;
    }
    
    if (currentStep === 2 && !selectedDoctor) {
        alert('Please select a doctor');
        return;
    }
    
    if (currentStep === 3 && (!selectedDate || !selectedTime)) {
        alert('Please select date and time');
        return;
    }
    
    currentStep++;
    updateStepDisplay();
    
    if (currentStep === 2) {
        loadDoctors();
    } else if (currentStep === 5) {
        generateConfirmationSummary();
    }
}

function previousStep() {
    currentStep--;
    updateStepDisplay();
}

function updateStepDisplay() {
    // Hide all steps
    document.querySelectorAll('.booking-card').forEach(card => {
        card.style.display = 'none';
    });
    
    // Show current step
    const stepMapping = {
        1: 'serviceStep',
        2: 'doctorStep',
        3: 'dateTimeStep',
        4: 'detailsStep',
        5: 'confirmationStep'
    };
    
    document.getElementById(stepMapping[currentStep]).style.display = 'block';
    
    // Update step indicators
    document.querySelectorAll('.step').forEach((step, index) => {
        step.classList.remove('active', 'completed');
        if (index + 1 < currentStep) {
            step.classList.add('completed');
        } else if (index + 1 === currentStep) {
            step.classList.add('active');
        }
    });
    
    // Update navigation buttons
    document.getElementById('prevBtn').style.display = currentStep > 1 ? 'block' : 'none';
    document.getElementById('nextBtn').style.display = currentStep < 5 ? 'block' : 'none';
    document.getElementById('submitBtn').style.display = currentStep === 5 ? 'block' : 'none';
}

function updateSummary() {
    if (selectedService) {
        document.getElementById('selectedService').style.display = 'block';
        document.getElementById('serviceName').textContent = selectedService.name;
        document.getElementById('serviceDetails').textContent = `Duration: ${selectedService.duration} min | Fee: $${selectedService.fee}`;
        
        document.getElementById('appointmentFee').style.display = 'block';
        document.getElementById('totalFee').textContent = `$${selectedService.fee}`;
    }
    
    if (selectedDoctor) {
        document.getElementById('selectedDoctor').style.display = 'block';
        document.getElementById('doctorName').textContent = `Dr. ${selectedDoctor.name}`;
        document.getElementById('doctorSpecialty').textContent = selectedDoctor.specialty;
    }
    
    if (selectedDate && selectedTime) {
        document.getElementById('selectedDateTime').style.display = 'block';
        const date = new Date(selectedDate);
        document.getElementById('appointmentDate').textContent = date.toLocaleDateString('en-US', { 
            weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' 
        });
        document.getElementById('appointmentTime').textContent = selectedTime;
    }
}

function generateConfirmationSummary() {
    const summaryHtml = `
        <div class="row mb-3">
            <div class="col-sm-4"><strong>Service:</strong></div>
            <div class="col-sm-8">${selectedService.name}</div>
        </div>
        <div class="row mb-3">
            <div class="col-sm-4"><strong>Doctor:</strong></div>
            <div class="col-sm-8">Dr. ${selectedDoctor.name}</div>
        </div>
        <div class="row mb-3">
            <div class="col-sm-4"><strong>Date:</strong></div>
            <div class="col-sm-8">${new Date(selectedDate).toLocaleDateString()}</div>
        </div>
        <div class="row mb-3">
            <div class="col-sm-4"><strong>Time:</strong></div>
            <div class="col-sm-8">${selectedTime}</div>
        </div>
        <div class="row mb-3">
            <div class="col-sm-4"><strong>Duration:</strong></div>
            <div class="col-sm-8">${selectedService.duration} minutes</div>
        </div>
        <div class="row mb-3">
            <div class="col-sm-4"><strong>Fee:</strong></div>
            <div class="col-sm-8"><strong class="text-primary">$${selectedService.fee}</strong></div>
        </div>
    `;
    
    document.getElementById('appointmentSummary').innerHTML = summaryHtml;
}

function enableNextButton() {
    const nextBtn = document.getElementById('nextBtn');
    nextBtn.disabled = false;
    nextBtn.classList.remove('disabled');
}

function bookAppointment() {
    const formData = new FormData(document.getElementById('bookingForm'));
    
    // Add selected data to form
    formData.append('service_id', selectedService.id);
    formData.append('doctor_id', selectedDoctor.id);
    formData.append('appointment_date', selectedDate);
    formData.append('appointment_time', selectedTime);
    formData.append('fee', selectedService.fee);
    formData.append('duration', selectedService.duration);
    
    // Show loading
    document.getElementById('submitBtn').disabled = true;
    document.getElementById('submitBtn').innerHTML = '<i class="fas fa-spinner fa-spin"></i> Booking...';
    
    fetch('/appointments/api/book', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Redirect to success page
            window.location.href = `/appointments/confirmation/${data.appointment_id}`;
        } else {
            alert(data.message || 'Error booking appointment');
        }
    })
    .catch(error => {
        console.error('Error booking appointment:', error);
        alert('Error booking appointment. Please try again.');
    })
    .finally(() => {
        document.getElementById('submitBtn').disabled = false;
        document.getElementById('submitBtn').innerHTML = '<i class="fas fa-check"></i> Book Appointment';
    });
}

function generateStars(rating) {
    let stars = '';
    for (let i = 1; i <= 5; i++) {
        stars += `<i class="fas fa-star ${i <= rating ? 'text-warning' : 'text-muted'}"></i>`;
    }
    return stars;
}
</script>
{% endblock %}
