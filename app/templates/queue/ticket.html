{% extends "base.html" %}

{% block title %}Queue Ticket - HealthCare Clinic{% endblock %}

{% block extra_css %}
<style>
.ticket-container {
    max-width: 400px;
    margin: 0 auto;
    background: white;
    border: 2px dashed #ccc;
    border-radius: 10px;
    padding: 20px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}

.ticket-header {
    text-align: center;
    border-bottom: 1px solid #eee;
    padding-bottom: 15px;
    margin-bottom: 20px;
}

.ticket-number {
    font-size: 3rem;
    font-weight: bold;
    color: #007bff;
    text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
}

.priority-high { color: #dc3545; }
.priority-medium { color: #fd7e14; }
.priority-low { color: #6c757d; }

.qr-code {
    text-align: center;
    margin: 20px 0;
}

@media print {
    body * {
        visibility: hidden;
    }
    .ticket-container, .ticket-container * {
        visibility: visible;
    }
    .ticket-container {
        position: absolute;
        left: 0;
        top: 0;
        margin: 0;
        box-shadow: none;
    }
    .no-print {
        display: none !important;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-md-6">
            <div class="card shadow">
                <div class="card-body">
                    <div class="text-center mb-4">
                        <h4 class="text-success">
                            <i class="fas fa-check-circle"></i> Ticket Generated Successfully
                        </h4>
                        <p class="text-muted">Your queue ticket has been generated. Please take a seat and wait for your number to be called.</p>
                    </div>

                    <div class="ticket-container" id="ticketToPrint">
                        <div class="ticket-header">
                            <h5 class="mb-1">HealthCare Clinic</h5>
                            <small class="text-muted">Queue Management System</small>
                        </div>

                        <div class="text-center mb-3">
                            <div class="ticket-number {{ 'priority-high' if ticket.priority >= 4 else 'priority-medium' if ticket.priority == 3 else 'priority-low' }}">
                                {{ ticket.ticket_number }}
                            </div>
                            <div class="badge badge-{{ 'danger' if ticket.priority >= 4 else 'warning' if ticket.priority == 3 else 'secondary' }} mb-2">
                                {{ ticket.get_priority_name() }} Priority
                            </div>
                        </div>

                        <div class="row text-center mb-3">
                            <div class="col-6">
                                <strong>Patient:</strong><br>
                                <small>{{ ticket.patient.first_name }} {{ ticket.patient.last_name }}</small>
                            </div>
                            <div class="col-6">
                                <strong>Service:</strong><br>
                                <small>{{ ticket.service.title() }}</small>
                            </div>
                        </div>

                        <div class="row text-center mb-3">
                            <div class="col-6">
                                <strong>Date:</strong><br>
                                <small>{{ ticket.created_at.strftime('%Y-%m-%d') }}</small>
                            </div>
                            <div class="col-6">
                                <strong>Time:</strong><br>
                                <small>{{ ticket.created_at.strftime('%H:%M') }}</small>
                            </div>
                        </div>

                        <div class="text-center">
                            <div class="qr-code">
                                <div id="qrcode"></div>
                            </div>
                            <small class="text-muted">Scan for status updates</small>
                        </div>

                        <div class="mt-3 pt-3 border-top">
                            <small class="text-muted d-block text-center">
                                Please keep this ticket and wait for your number to be called.
                                <br>
                                Estimated wait time: <strong>{{ estimated_wait }} minutes</strong>
                            </small>
                        </div>
                    </div>

                    <div class="text-center mt-4 no-print">
                        <button class="btn btn-primary me-2" onclick="printTicket()">
                            <i class="fas fa-print"></i> Print Ticket
                        </button>
                        <a href="{{ url_for('queue.kiosk') }}" class="btn btn-outline-secondary me-2">
                            <i class="fas fa-plus"></i> Generate Another
                        </a>
                        <a href="{{ url_for('main.queue_status') }}" class="btn btn-outline-info">
                            <i class="fas fa-tv"></i> View Queue Status
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Queue Status Information -->
    <div class="row justify-content-center mt-4 no-print">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header bg-info text-white">
                    <h6 class="mb-0">
                        <i class="fas fa-info-circle"></i> Queue Information
                    </h6>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-md-3">
                            <h5 class="text-primary">{{ queue_info.current_position }}</h5>
                            <small>Your Position</small>
                        </div>
                        <div class="col-md-3">
                            <h5 class="text-warning">{{ queue_info.ahead_count }}</h5>
                            <small>Ahead of You</small>
                        </div>
                        <div class="col-md-3">
                            <h5 class="text-success">{{ queue_info.currently_serving }}</h5>
                            <small>Now Serving</small>
                        </div>
                        <div class="col-md-3">
                            <h5 class="text-info">{{ queue_info.estimated_wait }}</h5>
                            <small>Est. Wait (min)</small>
                        </div>
                    </div>
                    
                    <div class="mt-3 text-center">
                        <small class="text-muted">
                            <i class="fas fa-clock"></i> 
                            This page will automatically refresh every 30 seconds to show updated queue information.
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
<script>
// Generate QR code
QRCode.toCanvas(document.getElementById('qrcode'), 
    `${window.location.origin}/queue/status/${{'{{ ticket.id }}' }}`, 
    { width: 100, margin: 1 }, 
    function (error) {
        if (error) console.error(error);
    }
);

// Print function
function printTicket() {
    window.print();
}

// Auto-refresh queue information every 30 seconds
setInterval(function() {
    fetch(`/queue/status/{{ ticket.id }}/json`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.querySelector('.col-md-3:nth-child(1) h5').textContent = data.current_position;
                document.querySelector('.col-md-3:nth-child(2) h5').textContent = data.ahead_count;
                document.querySelector('.col-md-3:nth-child(3) h5').textContent = data.currently_serving;
                document.querySelector('.col-md-3:nth-child(4) h5').textContent = data.estimated_wait;
            }
        })
        .catch(error => console.error('Error updating queue info:', error));
}, 30000);

// Auto-print on mobile devices (optional)
if (/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)) {
    // Add a delay to allow page to load completely
    setTimeout(function() {
        if (confirm('Would you like to print this ticket?')) {
            printTicket();
        }
    }, 1000);
}
</script>
{% endblock %}
