{% extends "base.html" %}

{% block title %}Queue Management - HealthCare Clinic{% endblock %}

{% block extra_css %}
<style>
    .queue-card {
        transition: all 0.3s ease;
        border-left: 4px solid #dee2e6;
    }
    .queue-card.priority-urgent {
        border-left-color: #dc3545;
    }
    .queue-card.priority-high {
        border-left-color: #fd7e14;
    }
    .queue-card.priority-normal {
        border-left-color: #198754;
    }
    .queue-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    .status-badge {
        font-size: 0.8rem;
        padding: 0.25rem 0.5rem;
    }
    .queue-controls {
        position: sticky;
        top: 0;
        z-index: 100;
        background: white;
        padding: 1rem 0;
        margin-bottom: 1rem;
        border-bottom: 1px solid #dee2e6;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Queue Controls -->
    <div class="queue-controls">
        <div class="row align-items-center">
            <div class="col-md-6">
                <h2><i class="fas fa-users"></i> Queue Management</h2>
                <p class="text-muted mb-0">Manage patient queue and consultations</p>
            </div>
            <div class="col-md-6 text-end">
                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-primary" onclick="refreshQueue()">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                    <button type="button" class="btn btn-success" onclick="callNext()">
                        <i class="fas fa-arrow-right"></i> Call Next
                    </button>
                    <button type="button" class="btn btn-info" data-bs-toggle="modal" data-bs-target="#queueStatsModal">
                        <i class="fas fa-chart-bar"></i> Statistics
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Queue Overview -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4 class="mb-1">{{ waiting_count or 0 }}</h4>
                            <p class="mb-0">Waiting</p>
                        </div>
                        <i class="fas fa-clock fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-success text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4 class="mb-1">{{ in_consultation_count or 0 }}</h4>
                            <p class="mb-0">In Consultation</p>
                        </div>
                        <i class="fas fa-user-md fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-info text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4 class="mb-1">{{ completed_today or 0 }}</h4>
                            <p class="mb-0">Completed Today</p>
                        </div>
                        <i class="fas fa-check-circle fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-warning text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4 class="mb-1">{{ avg_wait_time or '0 min' }}</h4>
                            <p class="mb-0">Avg Wait Time</p>
                        </div>
                        <i class="fas fa-hourglass-half fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Service Filters -->
    <div class="row mb-3">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-6">
                            <label class="form-label">Filter by Service:</label>
                            <select class="form-select" id="serviceFilter" onchange="filterQueue()">
                                <option value="">All Services</option>
                                <option value="general">General Medicine</option>
                                <option value="dental">Dental Care</option>
                                <option value="pediatric">Pediatric Care</option>
                                <option value="emergency">Emergency</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Filter by Priority:</label>
                            <select class="form-select" id="priorityFilter" onchange="filterQueue()">
                                <option value="">All Priorities</option>
                                <option value="urgent">Urgent</option>
                                <option value="high">High</option>
                                <option value="normal">Normal</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Current Patient -->
    {% if current_patient %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-success">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0"><i class="fas fa-user-check"></i> Current Patient</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-8">
                            <h4>{{ current_patient.name }}</h4>
                            <p class="mb-1"><strong>Ticket:</strong> {{ current_patient.ticket_number }}</p>
                            <p class="mb-1"><strong>Service:</strong> {{ current_patient.service_type }}</p>
                            <p class="mb-1"><strong>Started:</strong> {{ current_patient.consultation_start_time.strftime('%H:%M') if current_patient.consultation_start_time }}</p>
                        </div>
                        <div class="col-md-4 text-end">
                            <button class="btn btn-primary me-2" onclick="viewPatient('{{ current_patient.id }}')">
                                <i class="fas fa-eye"></i> View Details
                            </button>
                            <button class="btn btn-success" onclick="completeConsultation('{{ current_patient.id }}')">
                                <i class="fas fa-check"></i> Complete
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Waiting Queue -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-list"></i> Waiting Queue</h5>
                </div>
                <div class="card-body">
                    <div id="queueList">
                        {% if queue_items %}
                            {% for item in queue_items %}
                            <div class="queue-card card mb-3 priority-{{ item.priority }}" data-service="{{ item.service_type }}" data-priority="{{ item.priority }}">
                                <div class="card-body">
                                    <div class="row align-items-center">
                                        <div class="col-md-1 text-center">
                                            <span class="badge bg-secondary status-badge">{{ item.ticket_number }}</span>
                                        </div>
                                        <div class="col-md-3">
                                            <h6 class="mb-1">{{ item.patient_name or 'Walk-in Patient' }}</h6>
                                            <small class="text-muted">{{ item.service_type }}</small>
                                        </div>
                                        <div class="col-md-2">
                                            <span class="badge bg-{{ 'danger' if item.priority == 'urgent' else 'warning' if item.priority == 'high' else 'success' }}">
                                                {{ item.priority.title() }}
                                            </span>
                                        </div>
                                        <div class="col-md-2">
                                            <small class="text-muted">
                                                {{ item.created_at.strftime('%H:%M') }}<br>
                                                <span id="wait-time-{{ item.id }}">{{ item.wait_time }}</span>
                                            </small>
                                        </div>
                                        <div class="col-md-2">
                                            {% if item.patient_id %}
                                            <small class="text-success">
                                                <i class="fas fa-user-check"></i> Registered
                                            </small>
                                            {% else %}
                                            <small class="text-warning">
                                                <i class="fas fa-user-plus"></i> Walk-in
                                            </small>
                                            {% endif %}
                                        </div>
                                        <div class="col-md-2 text-end">
                                            <div class="btn-group btn-group-sm">
                                                <button class="btn btn-primary" onclick="callPatient('{{ item.id }}')" title="Call Patient">
                                                    <i class="fas fa-phone"></i>
                                                </button>
                                                <button class="btn btn-info" onclick="viewQueueItem('{{ item.id }}')" title="View Details">
                                                    <i class="fas fa-eye"></i>
                                                </button>
                                                <button class="btn btn-warning" onclick="editPriority('{{ item.id }}')" title="Edit Priority">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                                <button class="btn btn-danger" onclick="removeFromQueue('{{ item.id }}')" title="Remove">
                                                    <i class="fas fa-times"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        {% else %}
                        <div class="text-center py-5">
                            <i class="fas fa-clipboard-list fa-3x text-muted mb-3"></i>
                            <h5 class="text-muted">No patients in queue</h5>
                            <p class="text-muted">Queue is empty. New patients will appear here automatically.</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Queue Statistics Modal -->
<div class="modal fade" id="queueStatsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-chart-bar"></i> Queue Statistics</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <canvas id="serviceChart"></canvas>
                    </div>
                    <div class="col-md-6">
                        <canvas id="waitTimeChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Patient Details Modal -->
<div class="modal fade" id="patientDetailsModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-user"></i> Patient Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="patientDetailsContent">
                <!-- Patient details will be loaded here -->
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let refreshInterval;

document.addEventListener('DOMContentLoaded', function() {
    // Auto-refresh every 30 seconds
    refreshInterval = setInterval(refreshQueue, 30000);
    
    // Update wait times every minute
    setInterval(updateWaitTimes, 60000);
});

function refreshQueue() {
    fetch('/queue/api/status')
        .then(response => response.json())
        .then(data => {
            location.reload(); // Simple reload for now
        })
        .catch(error => console.error('Error refreshing queue:', error));
}

function callNext() {
    fetch('/queue/api/call-next', {method: 'POST'})
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showNotification('Next patient called successfully', 'success');
                setTimeout(() => location.reload(), 1000);
            } else {
                showNotification(data.message || 'Error calling next patient', 'error');
            }
        })
        .catch(error => {
            console.error('Error calling next patient:', error);
            showNotification('Error calling next patient', 'error');
        });
}

function callPatient(queueId) {
    fetch(`/queue/api/call/${queueId}`, {method: 'POST'})
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showNotification('Patient called successfully', 'success');
                setTimeout(() => location.reload(), 1000);
            } else {
                showNotification(data.message || 'Error calling patient', 'error');
            }
        })
        .catch(error => {
            console.error('Error calling patient:', error);
            showNotification('Error calling patient', 'error');
        });
}

function completeConsultation(queueId) {
    if (confirm('Mark this consultation as complete?')) {
        fetch(`/queue/api/complete/${queueId}`, {method: 'POST'})
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification('Consultation completed successfully', 'success');
                    setTimeout(() => location.reload(), 1000);
                } else {
                    showNotification(data.message || 'Error completing consultation', 'error');
                }
            })
            .catch(error => {
                console.error('Error completing consultation:', error);
                showNotification('Error completing consultation', 'error');
            });
    }
}

function removeFromQueue(queueId) {
    if (confirm('Remove this patient from the queue?')) {
        fetch(`/queue/api/remove/${queueId}`, {method: 'DELETE'})
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification('Patient removed from queue', 'success');
                    setTimeout(() => location.reload(), 1000);
                } else {
                    showNotification(data.message || 'Error removing patient', 'error');
                }
            })
            .catch(error => {
                console.error('Error removing patient:', error);
                showNotification('Error removing patient', 'error');
            });
    }
}

function filterQueue() {
    const serviceFilter = document.getElementById('serviceFilter').value;
    const priorityFilter = document.getElementById('priorityFilter').value;
    const queueCards = document.querySelectorAll('.queue-card');
    
    queueCards.forEach(card => {
        const service = card.dataset.service;
        const priority = card.dataset.priority;
        
        const serviceMatch = !serviceFilter || service === serviceFilter;
        const priorityMatch = !priorityFilter || priority === priorityFilter;
        
        if (serviceMatch && priorityMatch) {
            card.style.display = 'block';
        } else {
            card.style.display = 'none';
        }
    });
}

function updateWaitTimes() {
    // Update wait times for all queue items
    document.querySelectorAll('[id^="wait-time-"]').forEach(element => {
        const queueId = element.id.replace('wait-time-', '');
        fetch(`/queue/api/wait-time/${queueId}`)
            .then(response => response.json())
            .then(data => {
                if (data.wait_time) {
                    element.textContent = data.wait_time;
                }
            })
            .catch(error => console.error('Error updating wait time:', error));
    });
}

function showNotification(message, type) {
    // Create and show notification
    const alertClass = type === 'success' ? 'alert-success' : 'alert-danger';
    const notification = document.createElement('div');
    notification.className = `alert ${alertClass} alert-dismissible fade show position-fixed`;
    notification.style.top = '20px';
    notification.style.right = '20px';
    notification.style.zIndex = '9999';
    notification.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(notification);
    
    // Auto-remove after 5 seconds
    setTimeout(() => {
        if (notification.parentNode) {
            notification.parentNode.removeChild(notification);
        }
    }, 5000);
}

// Cleanup on page unload
window.addEventListener('beforeunload', function() {
    if (refreshInterval) {
        clearInterval(refreshInterval);
    }
});
</script>
{% endblock %}
