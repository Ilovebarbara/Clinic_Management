{% extends "base.html" %}

{% block title %}System Configuration - Admin Panel{% endblock %}

{% block extra_css %}
<style>
    .config-section {
        background: white;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .config-item {
        border-bottom: 1px solid #eee;
        padding: 15px 0;
    }
    .config-item:last-child {
        border-bottom: none;
    }
    .status-indicator {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        display: inline-block;
        margin-right: 8px;
    }
    .status-active { background-color: #28a745; }
    .status-inactive { background-color: #dc3545; }
    .status-warning { background-color: #ffc107; }
    .system-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }
    .stat-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 20px;
        border-radius: 8px;
        text-align: center;
    }
    .stat-value {
        font-size: 2rem;
        font-weight: bold;
        margin-bottom: 5px;
    }
    .backup-section {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 20px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1>System Configuration</h1>
                <div>
                    <button class="btn btn-outline-primary" onclick="window.location.reload()">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                    <button class="btn btn-warning" onclick="exportSystemData()">
                        <i class="fas fa-download"></i> Export Data
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- System Health Overview -->
    <div class="system-stats">
        <div class="stat-card">
            <div class="stat-value" id="total-users">{{ total_users }}</div>
            <div>Total Users</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="total-patients">{{ total_patients }}</div>
            <div>Total Patients</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="total-appointments">{{ total_appointments }}</div>
            <div>Total Appointments</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="database-size">{{ database_size }}</div>
            <div>Database Size</div>
        </div>
    </div>

    <div class="row">
        <!-- System Settings -->
        <div class="col-lg-6">
            <div class="config-section">
                <h3><i class="fas fa-cog"></i> System Settings</h3>
                
                <div class="config-item">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <strong>Queue Auto-Refresh</strong>
                            <br><small class="text-muted">Automatically refresh queue status</small>
                        </div>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="queueAutoRefresh" checked>
                        </div>
                    </div>
                </div>

                <div class="config-item">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <strong>Email Notifications</strong>
                            <br><small class="text-muted">Send appointment reminders via email</small>
                        </div>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="emailNotifications">
                        </div>
                    </div>
                </div>

                <div class="config-item">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <strong>SMS Notifications</strong>
                            <br><small class="text-muted">Send appointment reminders via SMS</small>
                        </div>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="smsNotifications">
                        </div>
                    </div>
                </div>

                <div class="config-item">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <strong>Patient Self-Registration</strong>
                            <br><small class="text-muted">Allow patients to register online</small>
                        </div>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="selfRegistration" checked>
                        </div>
                    </div>
                </div>

                <div class="config-item">
                    <label for="appointmentBuffer" class="form-label">
                        <strong>Appointment Buffer Time (minutes)</strong>
                    </label>
                    <input type="number" class="form-control" id="appointmentBuffer" value="15" min="5" max="60">
                    <small class="text-muted">Buffer time between appointments</small>
                </div>

                <div class="config-item">
                    <label for="maxQueueSize" class="form-label">
                        <strong>Maximum Queue Size</strong>
                    </label>
                    <input type="number" class="form-control" id="maxQueueSize" value="50" min="10" max="200">
                    <small class="text-muted">Maximum number of patients in queue</small>
                </div>
            </div>
        </div>

        <!-- System Status -->
        <div class="col-lg-6">
            <div class="config-section">
                <h3><i class="fas fa-heartbeat"></i> System Status</h3>
                
                <div class="config-item">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <span class="status-indicator status-active"></span>
                            <strong>Database Connection</strong>
                        </div>
                        <span class="badge bg-success">Active</span>
                    </div>
                </div>

                <div class="config-item">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <span class="status-indicator status-active"></span>
                            <strong>Flask Application</strong>
                        </div>
                        <span class="badge bg-success">Running</span>
                    </div>
                </div>

                <div class="config-item">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <span class="status-indicator status-warning"></span>
                            <strong>Email Service</strong>
                        </div>
                        <span class="badge bg-warning">Not Configured</span>
                    </div>
                </div>

                <div class="config-item">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <span class="status-indicator status-warning"></span>
                            <strong>SMS Service</strong>
                        </div>
                        <span class="badge bg-warning">Not Configured</span>
                    </div>
                </div>

                <div class="config-item">
                    <div>
                        <strong>Server Information</strong>
                        <br>
                        <small class="text-muted">
                            Python: {{ python_version }}<br>
                            Flask: {{ flask_version }}<br>
                            Uptime: <span id="server-uptime">{{ server_uptime }}</span>
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Database Management -->
        <div class="col-lg-6">
            <div class="config-section">
                <h3><i class="fas fa-database"></i> Database Management</h3>
                
                <div class="backup-section">
                    <h5>Database Backup</h5>
                    <p class="text-muted">Regular backups ensure data safety</p>
                    
                    <div class="mb-3">
                        <label for="backupType" class="form-label">Backup Type</label>
                        <select class="form-select" id="backupType">
                            <option value="full">Full Backup</option>
                            <option value="data-only">Data Only</option>
                            <option value="schema-only">Schema Only</option>
                        </select>
                    </div>
                    
                    <div class="d-flex gap-2">
                        <button class="btn btn-primary" onclick="createBackup()">
                            <i class="fas fa-save"></i> Create Backup
                        </button>
                        <button class="btn btn-outline-primary" onclick="scheduleBackup()">
                            <i class="fas fa-clock"></i> Schedule
                        </button>
                    </div>
                    
                    <div class="mt-3">
                        <small class="text-muted">
                            Last backup: <span id="last-backup">{{ last_backup_date or 'Never' }}</span>
                        </small>
                    </div>
                </div>

                <div class="mt-4">
                    <h5>Database Maintenance</h5>
                    <div class="d-flex gap-2 flex-wrap">
                        <button class="btn btn-outline-warning btn-sm" onclick="optimizeDatabase()">
                            <i class="fas fa-tools"></i> Optimize
                        </button>
                        <button class="btn btn-outline-info btn-sm" onclick="analyzeDatabase()">
                            <i class="fas fa-chart-bar"></i> Analyze
                        </button>
                        <button class="btn btn-outline-secondary btn-sm" onclick="viewLogs()">
                            <i class="fas fa-file-alt"></i> View Logs
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- User Management -->
        <div class="col-lg-6">
            <div class="config-section">
                <h3><i class="fas fa-users"></i> User Management</h3>
                
                <div class="row text-center mb-3">
                    <div class="col-4">
                        <div class="border rounded p-2">
                            <strong>{{ staff_count }}</strong>
                            <br><small>Staff</small>
                        </div>
                    </div>
                    <div class="col-4">
                        <div class="border rounded p-2">
                            <strong>{{ doctor_count }}</strong>
                            <br><small>Doctors</small>
                        </div>
                    </div>
                    <div class="col-4">
                        <div class="border rounded p-2">
                            <strong>{{ active_sessions }}</strong>
                            <br><small>Active</small>
                        </div>
                    </div>
                </div>

                <div class="d-flex gap-2 flex-wrap">
                    <button class="btn btn-primary btn-sm" onclick="window.location.href='{{ url_for('admin.create_user') }}'">
                        <i class="fas fa-user-plus"></i> Add User
                    </button>
                    <button class="btn btn-outline-primary btn-sm" onclick="exportUsers()">
                        <i class="fas fa-download"></i> Export Users
                    </button>
                    <button class="btn btn-outline-warning btn-sm" onclick="bulkUserActions()">
                        <i class="fas fa-tasks"></i> Bulk Actions
                    </button>
                </div>

                <div class="mt-4">
                    <h5>Security</h5>
                    <div class="config-item">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <strong>Force Password Reset</strong>
                                <br><small class="text-muted">Require all users to change passwords</small>
                            </div>
                            <button class="btn btn-outline-danger btn-sm" onclick="forcePasswordReset()">
                                Execute
                            </button>
                        </div>
                    </div>
                    
                    <div class="config-item">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <strong>Session Timeout (minutes)</strong>
                                <br><small class="text-muted">Auto-logout inactive users</small>
                            </div>
                            <input type="number" class="form-control" style="width: 100px;" value="60" min="15" max="480">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="row">
        <div class="col-12">
            <div class="config-section">
                <h3><i class="fas fa-bolt"></i> Quick Actions</h3>
                <div class="row">
                    <div class="col-md-3 mb-2">
                        <button class="btn btn-outline-primary w-100" onclick="clearCache()">
                            <i class="fas fa-broom"></i> Clear Cache
                        </button>
                    </div>
                    <div class="col-md-3 mb-2">
                        <button class="btn btn-outline-info w-100" onclick="generateReports()">
                            <i class="fas fa-chart-line"></i> Generate Reports
                        </button>
                    </div>
                    <div class="col-md-3 mb-2">
                        <button class="btn btn-outline-success w-100" onclick="sendTestNotification()">
                            <i class="fas fa-bell"></i> Test Notifications
                        </button>
                    </div>
                    <div class="col-md-3 mb-2">
                        <button class="btn btn-outline-secondary w-100" onclick="systemHealthCheck()">
                            <i class="fas fa-stethoscope"></i> Health Check
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Configuration Save Modal -->
<div class="modal fade" id="configModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Save Configuration</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to save these configuration changes?</p>
                <div class="alert alert-warning">
                    <small>Some changes may require a system restart to take effect.</small>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveConfiguration()">Save Changes</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Configuration management functions
function saveConfiguration() {
    const config = {
        queueAutoRefresh: document.getElementById('queueAutoRefresh').checked,
        emailNotifications: document.getElementById('emailNotifications').checked,
        smsNotifications: document.getElementById('smsNotifications').checked,
        selfRegistration: document.getElementById('selfRegistration').checked,
        appointmentBuffer: document.getElementById('appointmentBuffer').value,
        maxQueueSize: document.getElementById('maxQueueSize').value
    };

    fetch('/admin/save-config', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(config)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            window.clinicApp.showAlert('Configuration saved successfully', 'success');
            bootstrap.Modal.getInstance(document.getElementById('configModal')).hide();
        } else {
            window.clinicApp.showAlert('Error saving configuration', 'danger');
        }
    })
    .catch(error => {
        window.clinicApp.showAlert('Error saving configuration', 'danger');
    });
}

function createBackup() {
    const backupType = document.getElementById('backupType').value;
    window.clinicApp.showAlert('Creating backup...', 'info');
    
    fetch('/admin/create-backup', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({type: backupType})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            window.clinicApp.showAlert('Backup created successfully', 'success');
            document.getElementById('last-backup').textContent = new Date().toLocaleString();
        } else {
            window.clinicApp.showAlert('Error creating backup', 'danger');
        }
    });
}

function optimizeDatabase() {
    window.clinicApp.showAlert('Optimizing database...', 'info');
    
    fetch('/admin/optimize-database', {method: 'POST'})
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            window.clinicApp.showAlert('Database optimized successfully', 'success');
        } else {
            window.clinicApp.showAlert('Error optimizing database', 'danger');
        }
    });
}

function systemHealthCheck() {
    window.clinicApp.showAlert('Running health check...', 'info');
    
    fetch('/admin/health-check')
    .then(response => response.json())
    .then(data => {
        let message = `Health Check Results:\n`;
        message += `Database: ${data.database ? 'OK' : 'Error'}\n`;
        message += `Memory Usage: ${data.memory_usage}%\n`;
        message += `Disk Space: ${data.disk_space}% used`;
        
        window.clinicApp.showAlert(message, data.overall_status === 'good' ? 'success' : 'warning');
    });
}

function exportSystemData() {
    window.location.href = '/admin/export-data';
}

function clearCache() {
    fetch('/admin/clear-cache', {method: 'POST'})
    .then(response => response.json())
    .then(data => {
        window.clinicApp.showAlert('Cache cleared successfully', 'success');
    });
}

// Auto-save configuration changes
document.addEventListener('DOMContentLoaded', function() {
    const configInputs = document.querySelectorAll('#queueAutoRefresh, #emailNotifications, #smsNotifications, #selfRegistration, #appointmentBuffer, #maxQueueSize');
    
    configInputs.forEach(input => {
        input.addEventListener('change', function() {
            // Show save button or auto-save after delay
            setTimeout(() => {
                const modal = new bootstrap.Modal(document.getElementById('configModal'));
                modal.show();
            }, 1000);
        });
    });
});
</script>
{% endblock %}
